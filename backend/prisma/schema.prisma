// Prisma Schema for Antia Platform
// Generator and Datasource

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  CLIENT
  TIPSTER
  ADMIN
  SUPERADMIN
  SUPPORT
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  REJECTED
  PENDING
}

enum PayoutMethod {
  IBAN
  PAYPAL
  USDT
}

enum BillingType {
  ONE_TIME
  SUBSCRIPTION
}

enum BillingPeriod {
  DAY
  WEEK
  MONTH
  YEAR
}

enum AccessMode {
  AUTO_JOIN
  MODERATED
}

enum OrderStatus {
  CREATED
  PAGADA
  PAGADA_SIN_ACCESO
  ACCESS_GRANTED
  REFUNDED
  EXPIRED
}

enum AccessGrantStatus {
  PENDING
  GRANTED
  EXPIRED
}

enum HouseMethod {
  API
  CSV
  EMAIL
}

enum HouseStatus {
  ACTIVE
  DISABLED
}

enum AttributionModel {
  LAST_CLICK
}

enum ReferralEventType {
  CLICK
  REGISTER
  FTD
  DEPOSIT
}

enum ReferralEventStatus {
  RAW
  STANDARDIZED
  PENDING
  VALID
  REJECTED
}

enum ReferralEventSource {
  API
  CSV
  EMAIL
}

enum CommissionType {
  CPA
  REVSHARE
  HYBRID
}

enum CommissionStatus {
  ESTIMATED
  FINAL
  PAID
}

enum PayoutStatus {
  IN_PROCESS
  APPROVED
  PAID
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
}

enum TicketRole {
  CLIENT
  TIPSTER
}

enum WebhookDirection {
  IN
  OUT
}

enum WebhookStatus {
  OK
  FAIL
}

enum OtpKind {
  EMAIL
  PHONE
}

enum OtpDelivery {
  EMAIL
  SMS
}

// Models

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  phone         String?
  passwordHash  String      @map("password_hash")
  role          UserRole    @default(CLIENT)
  status        UserStatus  @default(PENDING)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  tipsterProfile TipsterProfile?
  clientProfile  ClientProfile?
  orders         Order[]
  tickets        Ticket[]
  auditLogs      AuditLog[]
  otpTokens      OtpToken[]

  @@map("users")
}

model TipsterProfile {
  id              String        @id @default(uuid())
  userId          String        @unique @map("user_id")
  publicName      String        @map("public_name")
  avatarUrl       String?       @map("avatar_url")
  telegramUsername String?      @map("telegram_username")
  telegramUserId  String?       @map("telegram_user_id")
  botLinkedAt     DateTime?     @map("bot_linked_at")
  payoutMethod    PayoutMethod? @map("payout_method")
  payoutFields    Json?         @map("payout_fields")
  locale          String        @default("es")
  timezone        String        @default("Europe/Madrid")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  products      Product[]
  referralLinks ReferralLink[]
  commissions   Commission[]
  payouts       Payout[]

  @@map("tipster_profiles")
}

model ClientProfile {
  id              String    @id @default(uuid())
  userId          String    @unique @map("user_id")
  countryIso      String    @map("country_iso")
  telegramUserId  String?   @map("telegram_user_id")
  consent18       Boolean   @default(false) @map("consent_18")
  consentTerms    Boolean   @default(false) @map("consent_terms")
  consentPrivacy  Boolean   @default(false) @map("consent_privacy")
  locale          String    @default("es")
  timezone        String    @default("Europe/Madrid")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("client_profiles")
}

model Product {
  id              String         @id @default(uuid())
  tipsterId       String         @map("tipster_id")
  title           String
  description     String?
  priceCents      Int            @map("price_cents")
  currency        String         @default("EUR")
  billingType     BillingType    @map("billing_type")
  billingPeriod   BillingPeriod? @map("billing_period")
  capacityLimit   Int?           @map("capacity_limit")
  active          Boolean        @default(true)
  telegramChannelId String?      @map("telegram_channel_id")
  accessMode      AccessMode     @default(AUTO_JOIN) @map("access_mode")
  validityDays    Int?           @map("validity_days")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  tipster       TipsterProfile     @relation(fields: [tipsterId], references: [id], onDelete: Cascade)
  orders        Order[]

  @@map("products")
}

model Order {
  id               String       @id @default(uuid())
  productId        String       @map("product_id")
  tipsterId        String       @map("tipster_id")
  clientUserId     String?      @map("client_user_id")
  emailBackup      String       @map("email_backup")
  phoneBackup      String?      @map("phone_backup")
  amountCents      Int          @map("amount_cents")
  currency         String       @default("EUR")
  paymentProvider  String       @map("payment_provider")
  providerOrderId  String?      @map("provider_order_id")
  status           OrderStatus  @default(CREATED)
  meta             Json?
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  product       Product              @relation(fields: [productId], references: [id])
  client        User?                @relation(fields: [clientUserId], references: [id])
  receipts      Receipt[]
  accessGrants  ChannelAccessGrant[]

  @@map("orders")
}

model Receipt {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  pdfUrl    String?  @map("pdf_url")
  issuedAt  DateTime @default(now()) @map("issued_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("receipts")
}

model ChannelAccessGrant {
  id            String              @id @default(uuid())
  orderId       String              @map("order_id")
  clientUserId  String              @map("client_user_id")
  channelId     String              @map("channel_id")
  status        AccessGrantStatus   @default(PENDING)
  joinedAt      DateTime?           @map("joined_at")
  leftAt        DateTime?           @map("left_at")
  createdAt     DateTime            @default(now()) @map("created_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("channel_access_grants")
}

model House {
  id                    String         @id @default(uuid())
  name                  String
  method                HouseMethod
  timezone              String         @default("Europe/Madrid")
  currency              String         @default("EUR")
  apiBaseUrl            String?        @map("api_base_url")
  credentials           Json?
  commissionRules       Json           @map("commission_rules")
  validationWindowDays  Int            @default(30) @map("validation_window_days")
  attributionModel      AttributionModel @default(LAST_CLICK) @map("attribution_model")
  status                HouseStatus    @default(ACTIVE)
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  // Relations
  referralLinks  ReferralLink[]
  referralEvents ReferralEvent[]
  commissions    Commission[]

  @@map("houses")
}

model ReferralLink {
  id              String       @id @default(uuid())
  tipsterId       String       @map("tipster_id")
  houseId         String       @map("house_id")
  urlTemplate     String       @map("url_template")
  subidParamName  String       @map("subid_param_name")
  status          HouseStatus  @default(ACTIVE)
  createdAt       DateTime     @default(now()) @map("created_at")

  // Relations
  tipster TipsterProfile @relation(fields: [tipsterId], references: [id], onDelete: Cascade)
  house   House          @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@map("referral_links")
}

model ReferralEvent {
  id           String                @id @default(uuid())
  houseId      String                @map("house_id")
  tipsterId    String?               @map("tipster_id")
  subid        String?
  userExtId    String?               @map("user_ext_id")
  type         ReferralEventType
  amountCents  Int?                  @map("amount_cents")
  currency     String?
  eventAt      DateTime              @map("event_at")
  source       ReferralEventSource
  status       ReferralEventStatus   @default(RAW)
  rawPayload   Json                  @map("raw_payload")
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")

  // Relations
  house House @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@map("referral_events")
}

model Commission {
  id              String           @id @default(uuid())
  tipsterId       String           @map("tipster_id")
  houseId         String           @map("house_id")
  periodMonth     String           @map("period_month") // Format: YYYY-MM
  type            CommissionType
  estimatedCents  Int              @map("estimated_cents")
  finalCents      Int?             @map("final_cents")
  currency        String           @default("EUR")
  fxRate          Float?           @map("fx_rate")
  status          CommissionStatus @default(ESTIMATED)
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  tipster TipsterProfile @relation(fields: [tipsterId], references: [id], onDelete: Cascade)
  house   House          @relation(fields: [houseId], references: [id], onDelete: Cascade)

  @@map("commissions")
}

model Payout {
  id                String        @id @default(uuid())
  tipsterId         String        @map("tipster_id")
  periodStart       DateTime      @map("period_start")
  periodEnd         DateTime      @map("period_end")
  grossCents        Int           @map("gross_cents")
  platformFeeBps    Int           @map("platform_fee_bps") // Basis points (e.g., 1000 = 10%)
  platformFeeCents  Int           @map("platform_fee_cents")
  netCents          Int           @map("net_cents")
  currency          String        @default("EUR")
  status            PayoutStatus  @default(IN_PROCESS)
  methodSnapshot    Json          @map("method_snapshot")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  tipster TipsterProfile @relation(fields: [tipsterId], references: [id], onDelete: Cascade)

  @@map("payouts")
}

model PlatformFeeTier {
  id                 String @id @default(uuid())
  thresholdGrossCents Int   @map("threshold_gross_cents")
  feeBps             Int    @map("fee_bps") // Basis points

  @@map("platform_fee_tiers")
}

model Ticket {
  id           String        @id @default(uuid())
  requesterId  String        @map("requester_id")
  role         TicketRole
  topic        String
  status       TicketStatus  @default(OPEN)
  context      Json?
  messages     Json          @default("[]")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  requester User @relation(fields: [requesterId], references: [id], onDelete: Cascade)

  @@map("tickets")
}

model AuditLog {
  id        String    @id @default(uuid())
  actorId   String?   @map("actor_id")
  action    String
  entity    String
  entityId  String    @map("entity_id")
  before    Json?
  after     Json?
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  actor User? @relation(fields: [actorId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model WebhookLog {
  id         String          @id @default(uuid())
  direction  WebhookDirection
  target     String
  payload    Json
  signature  String?
  status     WebhookStatus
  attempts   Int             @default(1)
  lastError  String?         @map("last_error")
  createdAt  DateTime        @default(now()) @map("created_at")

  @@map("webhook_logs")
}

model Config {
  id        String   @id @default(uuid())
  key       String   @unique
  valueJson Json     @map("value_json")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configs")
}

model OtpToken {
  id        String      @id @default(uuid())
  userId    String?     @map("user_id")
  kind      OtpKind
  delivery  OtpDelivery
  codeHash  String      @map("code_hash")
  expiresAt DateTime    @map("expires_at")
  usedAt    DateTime?   @map("used_at")
  createdAt DateTime    @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_tokens")
}

model ApiKey {
  id        String   @id @default(uuid())
  name      String
  keyHash   String   @unique @map("key_hash")
  scopes    Json     @default("[]")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("api_keys")
}
