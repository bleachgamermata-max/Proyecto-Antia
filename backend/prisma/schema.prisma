// Prisma Schema for Antia Platform - MongoDB
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Main Models
model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  email         String   @unique
  phone         String?
  passwordHash  String   @map("password_hash")
  role          String   @default("CLIENT") // CLIENT, TIPSTER, ADMIN, SUPERADMIN, SUPPORT
  status        String   @default("PENDING") // ACTIVE, SUSPENDED, REJECTED, PENDING
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model TipsterProfile {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  userId           String    @unique @map("user_id")
  publicName       String    @map("public_name")
  avatarUrl        String?   @map("avatar_url")
  telegramUsername String?   @map("telegram_username")
  telegramUserId   String?   @map("telegram_user_id")
  botLinkedAt      DateTime? @map("bot_linked_at")
  payoutMethod     String?   @map("payout_method") // IBAN, PAYPAL, USDT
  payoutFields     Json?     @map("payout_fields")
  locale           String    @default("es")
  timezone         String    @default("Europe/Madrid")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("tipster_profiles")
}

model ClientProfile {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  userId          String   @unique @map("user_id")
  countryIso      String   @map("country_iso")
  telegramUserId  String?  @map("telegram_user_id")
  consent18       Boolean  @default(false) @map("consent_18")
  consentTerms    Boolean  @default(false) @map("consent_terms")
  consentPrivacy  Boolean  @default(false) @map("consent_privacy")
  locale          String   @default("es")
  timezone        String   @default("Europe/Madrid")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("client_profiles")
}

model Product {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  tipsterId         String   @map("tipster_id")
  title             String
  description       String?
  priceCents        Int      @map("price_cents")
  currency          String   @default("EUR")
  billingType       String   @map("billing_type") // ONE_TIME, SUBSCRIPTION
  billingPeriod     String?  @map("billing_period") // DAY, WEEK, MONTH, YEAR
  capacityLimit     Int?     @map("capacity_limit")
  active            Boolean  @default(true)
  telegramChannelId String?  @map("telegram_channel_id")
  accessMode        String   @default("AUTO_JOIN") @map("access_mode")
  validityDays      Int?     @map("validity_days")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("products")
}

model Order {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  productId       String   @map("product_id")
  tipsterId       String   @map("tipster_id")
  clientUserId    String?  @map("client_user_id")
  emailBackup     String   @map("email_backup")
  phoneBackup     String?  @map("phone_backup")
  amountCents     Int      @map("amount_cents")
  currency        String   @default("EUR")
  paymentProvider String   @map("payment_provider")
  providerOrderId String?  @map("provider_order_id")
  status          String   @default("CREATED") // CREATED, PAGADA, PAGADA_SIN_ACCESO, ACCESS_GRANTED, REFUNDED, EXPIRED
  meta            Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("orders")
}

model Receipt {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId  String   @map("order_id")
  pdfUrl   String?  @map("pdf_url")
  issuedAt DateTime @default(now()) @map("issued_at")

  @@map("receipts")
}

model ChannelAccessGrant {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  orderId      String    @map("order_id")
  clientUserId String    @map("client_user_id")
  channelId    String    @map("channel_id")
  status       String    @default("PENDING") // PENDING, GRANTED, EXPIRED
  joinedAt     DateTime? @map("joined_at")
  leftAt       DateTime? @map("left_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  @@map("channel_access_grants")
}

model House {
  id                   String   @id @default(auto()) @map("_id") @db.ObjectId
  name                 String
  method               String // API, CSV, EMAIL
  timezone             String   @default("Europe/Madrid")
  currency             String   @default("EUR")
  apiBaseUrl           String?  @map("api_base_url")
  credentials          Json?
  commissionRules      Json     @map("commission_rules")
  validationWindowDays Int      @default(30) @map("validation_window_days")
  attributionModel     String   @default("LAST_CLICK") @map("attribution_model")
  status               String   @default("ACTIVE")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@map("houses")
}

model ReferralLink {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  tipsterId      String   @map("tipster_id")
  houseId        String   @map("house_id")
  urlTemplate    String   @map("url_template")
  subidParamName String   @map("subid_param_name")
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("referral_links")
}

model ReferralEvent {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  houseId     String   @map("house_id")
  tipsterId   String?  @map("tipster_id")
  subid       String?
  userExtId   String?  @map("user_ext_id")
  type        String // CLICK, REGISTER, FTD, DEPOSIT
  amountCents Int?     @map("amount_cents")
  currency    String?
  eventAt     DateTime @map("event_at")
  source      String // API, CSV, EMAIL
  status      String   @default("RAW") // RAW, STANDARDIZED, PENDING, VALID, REJECTED
  rawPayload  Json     @map("raw_payload")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("referral_events")
}

model Commission {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  tipsterId      String   @map("tipster_id")
  houseId        String   @map("house_id")
  periodMonth    String   @map("period_month")
  type           String // CPA, REVSHARE, HYBRID
  estimatedCents Int      @map("estimated_cents")
  finalCents     Int?     @map("final_cents")
  currency       String   @default("EUR")
  fxRate         Float?   @map("fx_rate")
  status         String   @default("ESTIMATED") // ESTIMATED, FINAL, PAID
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("commissions")
}

model Payout {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  tipsterId        String   @map("tipster_id")
  periodStart      DateTime @map("period_start")
  periodEnd        DateTime @map("period_end")
  grossCents       Int      @map("gross_cents")
  platformFeeBps   Int      @map("platform_fee_bps")
  platformFeeCents Int      @map("platform_fee_cents")
  netCents         Int      @map("net_cents")
  currency         String   @default("EUR")
  status           String   @default("IN_PROCESS") // IN_PROCESS, APPROVED, PAID
  methodSnapshot   Json     @map("method_snapshot")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("payouts")
}

model Ticket {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  requesterId String   @map("requester_id")
  role        String // CLIENT, TIPSTER
  topic       String
  status      String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED
  context     Json?
  messages    Json     @default("[]")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("tickets")
}

model OtpToken {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?   @map("user_id")
  kind      String // EMAIL, PHONE
  delivery  String // EMAIL, SMS
  codeHash  String    @map("code_hash")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("otp_tokens")
}

model Config {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  valueJson Json     @map("value_json")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configs")
}
